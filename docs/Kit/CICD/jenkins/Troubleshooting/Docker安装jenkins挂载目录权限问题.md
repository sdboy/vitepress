---
lang: zh-CN
title: jenkins
titleTemplate: Dockerå®‰è£…jenkinsæŒ‚è½½æœ¬åœ°ç›®å½•æƒé™é—®é¢˜
description: Dockerå®‰è£…jenkinsæŒ‚è½½æœ¬åœ°ç›®å½•æƒé™é—®é¢˜
head:
  - - meta
    - name: description
      content: Dockerå®‰è£…jenkinsæŒ‚è½½æœ¬åœ°ç›®å½•æƒé™é—®é¢˜
  - - meta
    - name: keywords
      content: jenkins docker linux æƒé™
layout: doc
navbar: true
sidebar: true
aside: true
outline: deep
lastUpdated: Date
footer: true
---
# Dockerå®‰è£…jenkinsæŒ‚è½½æœ¬åœ°ç›®å½•æƒé™é—®é¢˜

- è¿è¡Œç¯å¢ƒï¼šUbuntu 24.04 LTS
- é”™è¯¯ä¿¡æ¯ï¼šCan not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions
- å®¹å™¨å†…ç”¨æˆ·ä¿¡æ¯ï¼šuid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins)
- æŒ‚è½½è·¯å¾„çš„æƒé™ä¿¡æ¯ï¼šdrwxrwxrwx 3 root root 4096 May 21 01:18 /srv/jenkins

## é—®é¢˜æ€è€ƒ


å¥½çš„ï¼Œç”¨æˆ·é‡åˆ°äº†Jenkinså®¹å™¨åœ¨Ubuntu 24.04ä¸Šè¿è¡Œæ—¶çš„æƒé™é—®é¢˜ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯æ— æ³•å†™å…¥/var/jenkins_home/copy_reference_file.logï¼Œæç¤ºå·æƒé™é”™è¯¯ã€‚ç”¨æˆ·ä¹‹å‰è®¨è®ºè¿‡å¤–å‘é‚®ä»¶è¿è¥å’ŒDockeræŒ‚è½½æœ¬åœ°ç›®å½•çš„æƒé™è§£å†³åŠæ³•ï¼Œç°åœ¨éœ€è¦å…·ä½“å¤„ç†è¿™ä¸ªJenkinsçš„æƒ…å†µã€‚

é¦–å…ˆï¼Œç”¨æˆ·å·²ç»æåˆ°å®¹å™¨å†…çš„ç”¨æˆ·æ˜¯jenkinsï¼ŒUIDå’ŒGIDéƒ½æ˜¯1000ã€‚å®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•æƒé™å¯èƒ½ä¸æ˜¯1000:1000ï¼Œæˆ–è€…å®¹å™¨å†…çš„ç”¨æˆ·æ²¡æœ‰æƒé™è®¿é—®æŒ‚è½½ç‚¹ã€‚å¦å¤–ï¼ŒUbuntu 24.04å¯èƒ½å¯ç”¨äº†AppArmorå®‰å…¨ç­–ç•¥ï¼Œé™åˆ¶äº†è®¿é—®ã€‚é”™è¯¯å‘ç”Ÿåœ¨å¯åŠ¨Jenkinså®¹å™¨æ—¶ï¼Œé€šå¸¸æ˜¯å› ä¸ºæŒ‚è½½çš„å·æ²¡æœ‰æ­£ç¡®çš„æƒé™ï¼Œå¯¼è‡´å®¹å™¨é‡Œçš„jenkinsç”¨æˆ·æ— æ³•åˆ›å»ºæ—¥å¿—æ–‡ä»¶ã€‚

éœ€è¦å›é¡¾ç”¨æˆ·ä¹‹å‰æåˆ°çš„å‡ ç§æƒé™è§£å†³æ–¹æ³•ã€‚æ¯”å¦‚UID/GIDåŒ¹é…ã€SELinux/AppArmorè®¾ç½®ã€è°ƒæ•´ç›®å½•æƒé™ã€ä½¿ç”¨å‘½åå·ç­‰ã€‚è¿™é‡Œç”¨æˆ·çš„ç¯å¢ƒä¸æ˜¯Kubernetesï¼Œæ‰€ä»¥ä¸»è¦è€ƒè™‘Dockeræœ¬èº«çš„é…ç½®é—®é¢˜ã€‚

å¯èƒ½çš„åŸå› æœ‰å‡ ä¸ªæ–¹é¢ï¼š
1. å®¿ä¸»æœºç›®å½•çš„å±ä¸»ä¸æ˜¯UID 1000:1000çš„ç”¨æˆ·ã€‚
2. Ubuntuçš„AppArmorç­–ç•¥é™åˆ¶äº†å®¹å™¨å¯¹æŒ‚è½½ç‚¹çš„è®¿é—®ã€‚
3. å®¹å™¨å†…çš„jenkinsç”¨æˆ·æ²¡æœ‰å¯¹åº”çš„æƒé™é…ç½®ã€‚

ç”¨æˆ·å¯èƒ½å·²ç»å°è¯•è¿‡æŒ‚è½½ç›®å½•ï¼Œä½†æƒé™æ²¡æœ‰æ­£ç¡®è®¾ç½®ï¼Œæˆ–è€…æ²¡æœ‰ä½¿ç”¨æ­£ç¡®çš„é€‰é¡¹ã€‚ä¾‹å¦‚ï¼Œç›´æ¥æŒ‚è½½ä¼šå¯¼è‡´æƒé™ä¸è¶³ï¼Œå°¤å…¶æ˜¯åœ¨å®¿ä¸»æœºçš„ç›®å½•å±äºå¦ä¸€ä¸ªç”¨æˆ·çš„åœºæ™¯ã€‚

æ¥ä¸‹æ¥éœ€è¦åˆ†æƒ…å†µå¤„ç†ï¼š
- æ£€æŸ¥å®¿ä¸»æœºæŒ‚è½½ç›®å½•çš„æƒé™ï¼Œä½¿ç”¨chownä¿®æ”¹æ‰€æœ‰è€…ä¸º1000:1000ã€‚
- æˆ–è€…åœ¨è¿è¡Œå®¹å™¨æ—¶ç”¨--userå‚æ•°æŒ‡å®šç”¨æˆ·IDã€‚
- å¦‚æœå®¿ä¸»æœºçš„Jenkinsç›®å½•ä¸èƒ½æ›´æ”¹æƒé™ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å®¹å™¨å†…ç”¨æˆ·çš„UID/GIDæ¥åŒ¹é…å®¿ä¸»æœºç›®å½•ã€‚
- è¿˜è¦è€ƒè™‘AppArmorçš„é—®é¢˜ï¼Œåœ¨æŒ‚è½½æ—¶åŠ ä¸Šzæ ‡ç­¾æˆ–è€…è°ƒæ•´ç­–ç•¥ã€‚

å¯èƒ½çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬è°ƒæ•´å®¿ä¸»æœºç›®å½•æƒé™ã€ä¿®æ”¹å®¹å™¨ç”¨æˆ·æ˜ å°„ã€ç¦ç”¨AppArmorç­–ç•¥ï¼Œæˆ–è€…ç»“åˆDocker Composeçš„ç”¨æˆ·é…ç½®ã€‚å¦å¤–ï¼Œå‘½åå·å¯èƒ½æ›´å®¹æ˜“ç®¡ç†ï¼Œå› ä¸ºDockerä¼šè‡ªåŠ¨å¤„ç†æƒé™ï¼Œä½†å¦‚æœæ˜¯æœ¬åœ°ç›®å½•éœ€è¦æŒ‚è½½ï¼Œå¯èƒ½éœ€è¦å…¶ä»–æ–¹æ³•ã€‚

ç”¨æˆ·éœ€è¦çš„æ˜¯å…·ä½“çš„å‘½ä»¤å’Œæ­¥éª¤ï¼Œä»¥åŠå¦‚ä½•é¿å…å†æ¬¡å‡ºç°è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ã€‚åŒæ—¶è¦æé†’ç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒçš„ä¸åŒå¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚ä¸æ¨èä½¿ç”¨777æƒé™ï¼Œè€Œæ˜¯é€šè¿‡UIDåŒ¹é…å’Œå®‰å…¨ç­–ç•¥è°ƒæ•´ã€‚

éœ€è¦ç»™å‡ºæ¸…æ™°çš„æ­¥éª¤ï¼Œæ¯”å¦‚æ£€æŸ¥ç›®å½•æƒé™ã€ä¿®æ”¹chownã€è¿è¡Œæ—¶æ·»åŠ :zæ ‡ç­¾ç­‰ã€‚å¯èƒ½è¿˜éœ€è¦æŒ‡å¯¼ç”¨æˆ·å¦‚ä½•æ£€æŸ¥AppArmoræ˜¯å¦æœ‰é˜»æ‹¦ï¼Œå¹¶æä¾›æ—¥å¿—æ’æŸ¥çš„å‘½ä»¤ã€‚æœ€åï¼Œæ€»ç»“å®‰å…¨å’Œè¿ç»´å»ºè®®ï¼Œç¡®ä¿è§£å†³æ–¹æ¡ˆæ—¢æœ‰æ•ˆåˆå®‰å…¨ã€‚

### é—®é¢˜åˆ†æ

ä½ çš„å®¹å™¨æŠ¥é”™æ ¸å¿ƒä¿¡æ¯å¦‚ä¸‹ï¼š
```
Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions
```

è¯´æ˜å®¹å™¨å†…çš„ `jenkins` ç”¨æˆ·ï¼ˆUID=1000ï¼‰**æ— æ³•å†™å…¥æŒ‚è½½åˆ°å®¿ä¸»æœºçš„ç›®å½•**ï¼ˆå¦‚ `/var/jenkins_home`ï¼‰ï¼Œå¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š

1. **å®¿ä¸»æœºç›®å½•æƒé™ä¸åŒ¹é…**ï¼šå®¹å™¨å†…è¿è¡Œ jenkins ç”¨æˆ·ï¼ˆuid=1000ï¼‰æ—¶ï¼ŒæŒ‚è½½çš„å®¿ä¸»æœºç›®å½•**æ²¡æœ‰è¯¥ UID çš„å¯¹è±¡æƒé™**ã€‚
2. **AppArmor/SELinux é˜»æ‹¦**ï¼šUbuntu å¯ç”¨ AppArmor ç­‰å®‰å…¨ç­–ç•¥ï¼Œé˜»æ­¢å®¹å™¨å†™å…¥æ–‡ä»¶ã€‚
3. **æŒ‚è½½æ–¹å¼é”™è¯¯**ï¼šåƒ Jenkins è¿™æ ·ä¸¥æ ¼ä¾èµ–å†™å…¥ `/var/jenkins_home` çš„åº”ç”¨ï¼ŒåŒ…å«åˆå§‹åŒ–è„šæœ¬æƒé™æ ¡éªŒé€»è¾‘ï¼ˆå¦‚ `copy_reference_file` çš„è„šæœ¬ï¼‰ï¼Œæ— æ³•ç”± root ç”¨æˆ·ä¹‹å¤–è¿è¡Œï¼ˆé»˜è®¤ç”¨ `jenkins` ç”¨æˆ·ï¼‰ã€‚

---

### ğŸ’¡æ¨èè§£å†³æ–¹æ¡ˆ

---

#### âœ… æ–¹æ³•ä¸€ï¼šæŒ‚è½½ç›®å½•å¹¶æ›´æ”¹å±ä¸»ä¸º jenkins:1000

**æ­¥éª¤ï¼š**

1. **æŸ¥çœ‹ä½ æŒ‚è½½çš„å®¿ä¸»æœºç›®å½•åŸå±ä¸»ä¿¡æ¯**ï¼š
   ```bash
   ls -ld /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„
   ```

2. **å°†è¯¥å®¿ä¸»æœºç›®å½•çš„å±ä¸»æ”¹ä¸º UID=1000 çš„ç”¨æˆ·**ï¼ˆå› ä¸º Jenkins å®¹å™¨ç”¨ UID=1000 è´¦å·è¿è¡Œï¼‰ï¼š
   ```bash
   sudo chown -R 1000:1000 /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„
   ```

3. **é‡æ–°è¿è¡Œ Docker å‘½ä»¤**ï¼š
   ```bash
   docker run -d \
     -v /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„:/var/jenkins_home \
     -p 8080:8080 -p 50000:50000 \
     --name jenkins \
     jenkins/jenkins:lts
   ```

> è¿™æ˜¯æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆã€‚åªè¦å®¹å™¨å†…è¿è¡Œçš„æ˜¯ UID=1000 çš„ jenkins ç”¨æˆ·ï¼Œå¹¶ä¸”æŒ‚è½½å®¿ä¸»æœºç›®å½•ä¹Ÿå½’ä»–æ‰€æœ‰ï¼Œå°±ä¸ä¼šæŠ¥ "Wrong volume permissions"ã€‚

---

#### âœ… æ–¹æ³•äºŒï¼šä½¿ç”¨ `--user root` è¿è¡Œï¼ˆä¸æ¨èç”¨äºç”Ÿäº§ï¼‰

è‹¥ä½ ä»…ä¸ºå¼€å‘æµ‹è¯•ç®€åŒ–æµç¨‹ï¼Œ**å¿½ç•¥æƒé™æ§åˆ¶ä¸å½“çš„æƒ…å†µ**ï¼Œå¯ä»¥æš‚ä¸”ä½¿ç”¨ root ç”¨æˆ·å¯åŠ¨å®¹å™¨ï¼š

```bash
docker run -d \
  -v /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„:/var/jenkins_home \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  --user root \
  jenkins/jenkins:lts
```

âš ï¸ **è­¦å‘Š**ï¼š`--user root` ä¼šæš´éœ²å®¹å™¨å†… root æƒé™ï¼Œè‹¥è¯¥ç›®å½•æŒ‚è½½äº†å®¶ç›®å½•ç­‰æ•æ„Ÿè·¯å¾„ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ã€‚**ä»…å…è®¸å®¿ä¸»ç”¨æˆ·äº²è‡ªæ§åˆ¶çš„æµ‹è¯•ç¯å¢ƒä½¿ç”¨**ï¼ˆåˆ‡å‹¿é€Ÿç”¨äºç”Ÿäº§ï¼‰ã€‚

---

#### âœ… æ–¹æ³•ä¸‰ï¼šå®¹å™¨æŒ‚è½½ç›®å½•æ—¶æ·»åŠ  `:z` æ ‡ç­¾ï¼ˆé€‚é… AppArmorï¼‰

Ubuntu 24.04 æœ€æ–°ç‰ˆæœ¬é»˜è®¤å¯ç”¨ AppArmorï¼ˆç±»ä¼¼ SELinux çš„å®‰å…¨ç­–ç•¥æ¨¡å—ï¼‰ã€‚é€šè¿‡æ·»åŠ  `:z` å¯è‡ªåŠ¨é€‚é…å®¹å™¨å¯¹æŒ‚è½½ç‚¹çš„æƒé™ã€‚

```bash
docker run -d \
  -v /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„:/var/jenkins_home:z \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  jenkins/jenkins:lts
```

- `-v ...:z` ä¼šå‘ŠçŸ¥ Docker å®¹å™¨æŒ‚è½½æ—¶éœ€**ä¿®æ”¹ AppArmor æ ‡ç­¾** â†’ é€‚ç”¨äºå¼€å‘ç¯å¢ƒå¿«é€Ÿé€‚é…ã€‚
- `-v ...:Z` æ ‡ç­¾æ˜¯æ›´å½»åº•çš„è·¯å¾„éš”ç¦»ï¼ˆå®¹å™¨ä¸“ç”¨ä¸Šä¸‹æ–‡ï¼‰ï¼Œé€‚ç”¨äºä»…è¯¥å®¹å™¨ä½¿ç”¨è¯¥æŒ‚è½½è·¯å¾„çš„åœºæ™¯ã€‚

---

#### âœ… æ–¹æ³•å››ï¼šä½¿ç”¨ Docker Compose è‡ªåŠ¨åŒæ­¥ UID

ä½¿ç”¨ `docker-compose` ç®¡ç†ç”¨æˆ·æ˜¯æ¯”è¾ƒä¼˜é›…çš„å¤„ç†æ–¹å¼ï¼Œå…è®¸é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ UID/GIDã€‚

> ç¤ºä¾‹ `docker-compose.yml`ï¼š

```yaml
version: '3'
services:
  jenkins:
    image: jenkins/jenkins:lts
    user: "${UID}:${GID}"
    environment:
      - UID=${UID}
      - GID=${GID}
    volumes:
      - ./jenkins_data:/var/jenkins_home
    ports:
      - "8080:8080"
      - "50000:50000"
```

**å¯åŠ¨å‘½ä»¤ï¼š**
```bash
UID=$(id -u) GID=$(id -g) docker-compose up -d
```

è¿™æ ·å®¹å™¨å†… Jenkins å°±ä¼šä½¿ç”¨å’Œå®¿ä¸»æœºç›¸åŒçš„ UID/GIDï¼Œå®ç°æ— ç¼æƒé™å¯¹é½ã€‚

---

### ğŸ› ï¸ æ’æŸ¥ä¸éªŒè¯æµç¨‹

å¦‚æœä½ ä¸ç¡®å®šæ˜¯å“ªä¸ªé—®é¢˜é€ æˆçš„ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š

1. **æ£€æŸ¥å®¿ä¸»æœºæŒ‚è½½ç›®å½•çš„æƒé™**ï¼š
   ```bash
   ls -l /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„
   ```

   è‹¥æç¤ºï¼š
   ```
   drwxr-xr-x 1 root root xxx
   ```
   è¯´æ˜å½“å‰é jenkins ç”¨æˆ·å±ä¸»ã€‚

2. **æ£€æŸ¥å®¹å™¨æ‰€åœ¨çš„è¿è¡Œç”¨æˆ·**ï¼š
   ```bash
   docker exec -it jenkins whoami
   # æˆ–æŸ¥çœ‹è¿è¡Œæ—¶ UID
   docker exec -it jenkins id
   ```

3. **æŸ¥çœ‹å®¹å™¨å†…æ–‡ä»¶æƒé™ï¼ˆæ˜¯å¦åœ¨å®¹å™¨å†…æ— æ³•è¯»å†™æ—¥å¿—ï¼‰**ï¼š
   ```bash
   docker exec -it jenkins ls -l /var/jenkins_home
   # æŸ¥çœ‹ copy_reference_file.log çš„æƒé™
   docker exec -it jenkins ls -l /var/jenkins_home/copy_reference_file.log
   ```

4. **æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä»¥ç¡®è®¤è¯¦ç»†é”™è¯¯ï¼ˆå°¤å…¶æ˜¯æŒ‚è½½åçš„æ—¥å¿—ï¼‰**ï¼š
   ```bash
   docker logs jenkins
   ```

   å¦‚æœæœ‰å…³äºæ— æ³•è®¿é—® `copy_reference_file.log` æˆ–æ‹·è´é…ç½®å¤±è´¥çš„é”™è¯¯ï¼Œè¯´æ˜ç»‘å®šæŒ‚è½½æœªæˆæƒã€‚

---

### ğŸš¨ å®‰å…¨å»ºè®®

å¦‚æœä½ åœ¨**ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ Jenkins**ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- **ä¸è¦ç›´æ¥ä½¿ç”¨ `--user root`**ï¼Œé¿å… root ç»‘å®šæŒ‚è½½é€ æˆæ½œåœ¨çš„å†…æ ¸æƒé™è¶Šç•Œé—®é¢˜ã€‚
- **ä¸è¦è¿è¡Œ chmod 777**ï¼ˆé™¤ééå¸¸æ˜ç¡®çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼‰ã€‚
- **æœ€ä½³å®è·µï¼š** å®¿ä¸»æœºæŒ‚è½½è·¯å¾„çš„ **å±ä¸» UID å¿…é¡»ä¸å®¹å™¨å†… UID å¯¹åº”äººå‘˜è´¦å·ä¸€è‡´**ã€‚

ä¾‹å¦‚ï¼š
```bash
# åˆ›å»º Jenkins ç”¨æˆ·ï¼ŒUID=1000ï¼ˆç±»æ¯”å®¹å™¨å†…ç”¨æˆ·ï¼‰
sudo useradd -u 1000 jenkins
# ç„¶åè®¾ç½®å®¿ä¸»æœºæŒ‚è½½ç›®å½•çš„ owner
sudo chown -R jenkins:jenkins /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„
```

> ç¡®ä¿ Jenkins è¿è¡Œç”¨æˆ·åœ¨å®¿ä¸»æœºä¹Ÿå­˜åœ¨ï¼Œå¹¶æ‹¥æœ‰åŒ UIDï¼Œå†æ¬¡é‡å¯å®¹å™¨å³å¯æ­£å¸¸è¿è¡Œã€‚

---

### ğŸ” æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨å‘½åå·ï¼ˆNamed Volumeï¼‰

ç›¸æ¯”äº `/å®¿ä¸»æœº/è·¯å¾„`ï¼Œä½¿ç”¨ ** Docker å‘½åå·ï¼ˆnamed volumeï¼‰** æŒ‚è½½æ–¹å¼æ›´å®‰å…¨ï¼Œå› ä¸º Docker ä¼š**è‡ªåŠ¨å¤„ç†ç›®å½•æ‰€æœ‰è€…æƒé™**ã€‚

```bash
docker volume create jenkins_home
docker run -d \
  -v jenkins_home:/var/jenkins_home \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  jenkins/jenkins:lts
```

##### âœ… ä¼˜ç‚¹
- ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†æŒ‚è½½ç›®å½•æƒé™
- ä¸ä¾èµ–æœ¬åœ°ç›´æ¥æŒ‚è½½çš„ UID åŒ¹é…
- æ›´æ˜“è·¨ç‰ˆæœ¬è¿ç§»

å¦‚æœä½ æ­£åœ¨æ„å»º CI/CD å¹³å°ï¼Œæˆ–è¦åšé•œåƒéš”ç¦»ï¼Œè¿™æ˜¯ **æœ€æ¨èçš„åšæ³•**ã€‚

---

### ğŸ“Œ æ€»ç»“æ¨èæ–¹æ¡ˆï¼ˆæŒ‰ä½¿ç”¨åœºæ™¯åˆ†ç±»ï¼‰

| æƒ…å†µ                                  | æ¨èåšæ³•                                       | æ˜¯å¦é€‚åˆç”Ÿäº§ |
|----------------------------------------|------------------------------------------------|----------------|
| åˆæ¬¡å®‰è£…ï¼Œåªæƒ³å°½å¿«å¯åŠ¨æµ‹è¯•                | `docker run -v /host/dir:/var/jenkins_home:z`  | âŒï¼ˆä»…å¼€å‘ç”¨ï¼‰     |
| å®¿ä¸»æœºç°æœ‰ç›®å½•å¯ä¿®æ”¹å±ä¸»æƒé™              | `sudo chown -R 1000:1000 /å®¿ä¸»æœº/æŒ‚è½½ç›®å½•`     | âœ…âœ…ï¼ˆæœ€é€šç”¨ï¼‰     |
| Docker Compose ç”¨æˆ·ç²‰ä¸å¼ç®¡ç†/è¿ç»´åœºæ™¯     | è®¾ç½® `user: UID:GID` + ç¯å¢ƒå˜é‡æ³¨å…¥              | âœ…âœ…âœ…ï¼ˆæœ€ä½³è¿ç»´ï¼‰  |
| ä¸æƒ³æ‰‹åŠ¨ç®¡ç®¡ç†å®¿ä¸»æœºæƒé™ï¼Œä¿éšœç¨³å®šæ€§æ—¶      | ä½¿ç”¨å‘½åå· `docker volume create`               | âœ…âœ…âœ…ï¼ˆæœ€æ¨èï¼‰     |
| åšæŒä½¿ç”¨ root ç”¨æˆ·ï¼Œå¿«æ·å¯åŠ¨             | `--user root` å¹¶ç›´æ¥ chmod 777ï¼ˆéå¸¸è§„åšæ³•ï¼‰    | âŒâŒï¼ˆä»… CI æµ‹è¯•ï¼‰   |

---

### å¦‚æœä½ ä»åœ¨æŠ¥é”™ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤åé¦ˆï¼š
```bash
# æŒ‚è½½è·¯å¾„çš„æƒé™ä¿¡æ¯
ls -ld /å®¿ä¸»æœº/æŒ‚è½½è·¯å¾„

# Jenkins å®¹å™¨å®é™…è¿è¡Œæ—¶çš„ UID
docker exec -it jenkins id

# Jenkins å®¹å™¨åˆå§‹åŒ–å¤±è´¥æ—¥å¿—
docker logs jenkins | grep -i "permission denied\|wrong permissions"
```

æˆ‘å¯ä»¥ä¾æ®è¿™äº›ä¿¡æ¯ï¼Œç»™ä½ æ›´å®šåˆ¶çš„æƒé™ä¿®å¤å‘½ä»¤ ğŸ‘‡

## æ€è€ƒ


å¥½çš„ï¼Œç”¨æˆ·ç°åœ¨é‡åˆ°äº†Jenkinså®¹å™¨å¯åŠ¨æ—¶æ— æ³•å†™å…¥/var/jenkins_home/copy_reference_file.logçš„é—®é¢˜ã€‚æ ¹æ®ä¹‹å‰çš„å¯¹è¯ï¼Œä»–å·²ç»æä¾›äº†æŒ‚è½½è·¯å¾„çš„æƒé™ä¿¡æ¯æ˜¯drwxrwxrwxï¼Œç”±root:rootæ‹¥æœ‰ï¼Œè€Œå®¹å™¨å†…è¿è¡Œçš„ç”¨æˆ·æ˜¯jenkinsï¼ˆuid=1000ï¼‰ï¼Œæç¤ºæƒé™é”™è¯¯ã€‚

é¦–å…ˆï¼Œæˆ‘éœ€è¦ç¡®è®¤é—®é¢˜çš„å…³é”®ç‚¹ã€‚è™½ç„¶ç”¨æˆ·æä¾›çš„ç›®å½•æƒé™æ˜¯æ‰€æœ‰äººéƒ½æœ‰è¯»å†™æƒé™ï¼ˆ777ï¼‰ï¼Œè¿™é€šå¸¸åº”è¯¥å…è®¸å®¹å™¨å†…çš„ä»»ä½•ç”¨æˆ·å†™å…¥ï¼Œä½†Jenkinsè¿˜æ˜¯æŠ¥æƒé™é—®é¢˜ï¼Œè¯´æ˜å¯èƒ½è¿˜æœ‰åˆ«çš„å› ç´ å½±å“ã€‚

å¯èƒ½çš„é”™è¯¯åŸå› æœ‰ï¼š

1. UID/GIDä¸åŒ¹é…ï¼šå°½ç®¡ç›®å½•æƒé™å®½æ¾ï¼Œä½†Jenkinså®¹å™¨å†…è¿è¡Œçš„ç”¨æˆ·æ˜¯jenkins (1000)ï¼Œè€ŒæŒ‚è½½ç›®å½•çš„å±ä¸»æ˜¯root (uid=0)ã€‚æœ‰äº›ç³»ç»Ÿæˆ–åº”ç”¨åœ¨æŒ‚è½½æ—¶ä»ç„¶ä¼šæ£€æŸ¥å®é™…çš„ç”¨æˆ·æƒé™ï¼Œå³ä½¿ç›®å½•å…è®¸everyoneè®¿é—®ï¼ŒæŸäº›å®¹å™¨ç¯å¢ƒæˆ–å®‰å…¨ç­–ç•¥å¯èƒ½ä»ä¼šé™åˆ¶å®é™…çš„ç”¨æˆ·è®¿é—®ã€‚

2. AppArmor/SELinux é™åˆ¶ï¼šUbuntu 24.04å¯èƒ½å¯ç”¨äº†AppArmorï¼Œè™½ç„¶ç”¨æˆ·ä¹‹å‰æ²¡æœ‰æåˆ°ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®‰å…¨ç­–ç•¥å¯èƒ½é˜»æ­¢äº†å®¹å™¨è®¿é—®ï¼Œå³ä½¿æƒé™æ˜¯777ã€‚SELinuxé€šå¸¸ç”¨äºå…¶ä»–å‘è¡Œç‰ˆï¼Œä½†åœ¨Ubuntuä¸­AppArmoræ˜¯é»˜è®¤å¯ç”¨çš„ã€‚

3. Jenkinså†…éƒ¨æƒé™éªŒè¯ï¼šJenkinsæœ¬èº«å¯èƒ½åœ¨åˆå§‹åŒ–æ—¶æ£€æŸ¥åˆ°å®ƒéœ€è¦ç”±ç‰¹å®šç”¨æˆ·æ‹¥æœ‰ï¼Œå¦‚æœæŒ‚è½½çš„è·¯å¾„ä¸æ˜¯ç”±è¯¥ç”¨æˆ·ï¼ˆåœ¨è¿™é‡Œåº”è¯¥æ˜¯jenkinsï¼‰æ‹¥æœ‰ï¼Œå°±æ‹’ç»å¯åŠ¨ä»¥ä¿æŠ¤æ•°æ®ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨æŒ‚è½½ç›®å½•ç”±å®¿ä¸»çš„rootåˆ›å»ºï¼Œä½†å®¹å™¨ä½¿ç”¨érootç”¨æˆ·è¿è¡Œçš„æ—¶å€™ã€‚

ç°åœ¨ç»“åˆç”¨æˆ·æä¾›çš„ä¿¡æ¯ï¼š

- æŒ‚è½½ç›®å½•æ˜¯/srv/jenkinsï¼Œæƒé™æ˜¯drwxrwxrwxï¼Œå±äºroot:rootã€‚
- å®¹å™¨å†…çš„Jenkinsç”¨æˆ·
- UIDæ˜¯1000ã€‚

æ—¢ç„¶ç›®å½•æƒé™æ˜¯777ï¼Œç†è®ºä¸Šæ²¡æœ‰é—®é¢˜ï¼Œä½†ç”¨æˆ·è¿˜æ˜¯æŠ¥æ— æ³•å†™å…¥ã€‚è¿™å¯èƒ½æ˜¯ï¼š

- **AppArmor é™åˆ¶**ï¼šUbuntuçš„AppArmorç­–ç•¥é»˜è®¤ä¼šé˜»æ­¢é™¤rootå¤–çš„å®¹å™¨è®¿é—®æŸäº›å®¿ä¸»æœºç›®å½•ï¼Œå³ä½¿æƒé™æ˜¯æ‰€æœ‰äººéƒ½æœ‰è¯»å†™æƒé™ï¼ŒDockerçš„AppArmor profileä»å¯èƒ½é™åˆ¶å®¹å™¨å†…çš„érootç”¨æˆ·å¯¹å®¿ä¸»æœºrootæ‹¥æœ‰çš„ç›®å½•çš„è®¿é—®ã€‚

- **Jenkinsåˆå§‹åŒ–é€»è¾‘æ£€æŸ¥ç›®å½•å±ä¸»**ï¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶ï¼ŒJenkinsæ’ä»¶ç³»ç»Ÿæˆ–æŸäº›åˆå§‹åŒ–è„šæœ¬å¯èƒ½ä¼šå¯¹æŒ‚è½½ç›®å½•çš„å±ä¸»è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿å®ƒå½’å±äºå®¹å™¨å†…çš„ç”¨æˆ·ï¼ˆuid 1000ï¼‰ï¼Œå¦åˆ™ä¸è¿è¡Œå¯åŠ¨ã€‚æ‰€ä»¥åœ¨æƒé™å¯¹ä½†ownerä¸æ˜¯jenkinsçš„ç›®å½•ï¼ŒJenkinså¯èƒ½æ‹’ç»ä½¿ç”¨è¯¥ç›®å½•ã€‚

å› æ­¤ï¼Œæˆ‘çš„è§£å†³æ–¹æ¡ˆéœ€è¦åº”å¯¹AppArmorå’ŒJenkinsè‡ªèº«çš„æ£€æŸ¥ã€‚

---

### è§£å†³æ–¹æ³•

#### æ–¹æ³•ä¸€ï¼šè°ƒæ•´å®¿ä¸»æœºç›®å½•çš„å±ä¸»ä¸å®¹å™¨å†…uid=1000åŒ¹é…

è™½ç„¶ç”¨æˆ·æƒé™æ˜¯777ï¼Œä½† Jenkins **å¯èƒ½ä¼šæ£€æŸ¥ç›®å½•çš„ owner UID ä¸å®¹å™¨å†…è¿è¡Œçš„ç”¨æˆ· UID æ˜¯å¦ä¸€è‡´**ï¼Œå¹¶æ‹’ç»å¦‚æœä¸æ˜¯ç”¨æˆ· jenkins æ‰€æ‹¥æœ‰çš„ç›®å½•ã€‚å› æ­¤ä¿®æ­£ç›®å½• ownerï¼š

```bash
# æ›´æ”¹ç›®å½•å±ä¸»ä¸º uid 1000ï¼ˆç­‰åŒäºå®¹å™¨å†…çš„ jenkins ç”¨æˆ·ï¼‰
sudo chown -R 1000:1000 /srv/jenkins
```

æ­¤æ–¹æ³•ç›´æ¥å¯¹é½ Jenkins å®¹å™¨è¿è¡Œçš„ UIDï¼Œé¿å…å›  user namespace æˆ–å®‰å…¨ç­–ç•¥å¯¼è‡´çš„å†…éƒ¨æƒé™éªŒè¯å¤±è´¥ã€‚

---

#### æ–¹æ³•äºŒï¼šé‡æ–°ä½¿ç”¨å®¹å™¨å†…çš„ jenkins ç”¨æˆ·åï¼ˆè€Œä¸æ˜¯ä»… UID 1000ï¼‰ï¼Œæœ‰æ„å¿½ç•¥å®¿ä¸»æœºç”¨æˆ·éªŒè¯

å¦‚æœæ²¡æœ‰å°† container/jenkins ç”¨æˆ·æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œåˆ™å¯ä½¿ç”¨ dockered æƒé™è‡ªåŠ¨å¤„ç†æœºåˆ¶ï¼ˆ:z/:Zï¼‰ï¼Œä»¥ä¿®æ”¹ç›®å½• context ä»¥åŒ¹é…å®¹å™¨ï¼š

```bash
# ä½¿ç”¨ :z ä¿®æ”¹ AppArmor ä¸Šä¸‹æ–‡æ ‡ç­¾ï¼Œå…è®¸è®¿é—®
docker run -d \
  -v /srv/jenkins:/var/jenkins_home:z \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  jenkins/jenkins:lts
```

âš ï¸ï¼š`/srv/jenkins` ä»ç„¶å±äº root:rootï¼Œè¿™å¯èƒ½å¼•å‘ Jenkins è‡ªèº«çš„å®‰å…¨ check æƒé™éªŒè¯å¤±è´¥ã€‚`chmod 777` æ²¡æœ‰è§£å†³å®é™… UID æ‰€æœ‰è€…é—®é¢˜ã€‚

---

#### æ–¹æ³•ä¸‰ï¼šä»…ä½¿ç”¨ Docker å‘½åå·ï¼ˆrecommendedï¼‰

é¿å…æ‰‹åŠ¨ UID æ˜ å°„ï¼Œå¹¶æ›´å¥½åœ°å’Œ Docker è‡ªèº«æœºåˆ¶å…¼å®¹ï¼š

```bash
docker volume create jenkins_home

docker run -d \
  -v jenkins_home:/var/jenkins_home \
  -p 8080:8080 \
  --user $(id -u) \
  -p 50000:50000 \
  --name jenkins \
  jenkins/jenkins:lts
```

> Jenkins åœ¨é¦–æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è°ƒæ•´ volume æƒé™åˆ°å®ƒå†…éƒ¨çš„ jenkins ç”¨æˆ·ï¼Œä¸ä¾èµ–äººä¸ºè®¾ç½®ç›®å½•æƒé™ã€‚

---

#### æ–¹æ³•å››ï¼šä¸´æ—¶ç¦ç”¨ AppArmorï¼ˆä»… debug åœºæ™¯ï¼‰

å¦‚æœä½ ç¡®å®š AppArmor æ˜¯é™åˆ¶è®¿é—®çš„æ¥æºï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨ AppArmorï¼š
```bash
sudo ln -s /etc/apparmor.d/docker-override /etc/apparmor.d/disable/
sudo apparmor_parser -R /etc/apparmor.d/docker-override
```

> ä¸Šè¿°å‘½ä»¤ä¼š **ä»…è§£é™¤æŸäº›å®¹å™¨è·¯å¾„çš„ AppArmor protection**ã€‚è¿™ä¸€æ–¹æ³•å»ºè®® **ä»… debug ä½¿ç”¨**ã€‚

---

#### æ–¹æ³•å¯èƒ½ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ

åœ¨ `/var/jenkins_home` æŒ‚è½½æ•´ä¸ªç›®å½•è¿›å®¹å™¨æ—¶ï¼ŒJenkins ç¬¬ä¸€æ¬¡ä¼šè¿è¡Œï¼š
```bash
cat /usr/share/jenkins/ref/copy_reference_file.log > /var/jenkins_home/copy_reference_file.log
```
å¦‚æœå®¿ä¸»æœºç›®å½•æ˜¯ `root:root`ï¼Œä½† Jenkins æ˜¯è¿è¡Œåœ¨ UID 1000 çš„ç”¨æˆ·ï¼Œå®ƒå°±æ— æ³•å°†æŸä¸ªè„šæœ¬è¾“å‡ºé‡å®šå‘åˆ° root å±ä¸»çš„è·¯å¾„ã€‚

å³ä¾¿ `/var/jenkins_home` ï¼ˆå®¿ä¸»æŒ‚è½½è·¯å¾„ï¼‰çš„æƒé™ä¸º 777ï¼ŒAppArmor ä¼šé˜»æ­¢å®¹å™¨ UID 1000 ç”¨æˆ·å†™å…¥ UID 0 çš„æ–‡ä»¶ã€‚

æ­¤å¤–ï¼Œ Jenkins ä¼šæ£€æŸ¥æŸäº›é‡è¦æ•°æ®æ˜¯å¦å¯ç”±å½“å‰è¿è¡Œçš„ç”¨æˆ·å†™å…¥ï¼Œ**å¦åˆ™è®¤ä¸ºæƒé™é…ç½®é”™è¯¯**ï¼Œä»¥é¿å…å‡ºç°å› æƒé™å†²çªé€ æˆçš„æ•°æ®ä¸€è‡´æ€§å’Œå¯åŠ¨å¤±è´¥é—®é¢˜ã€‚

---

### æ“ä½œæˆåŠŸç‡æ’åºå»ºè®®ï¼ˆå°è¯•é¡ºåºï¼‰

1. **æ–¹æ³•ä¸€ï¼ˆ`chown -R 1000:1000 /srv/jenkins`ï¼‰**ï¼š èƒ½è§£å†³å¤§éƒ¨åˆ† Jenkins æƒé™åˆå§‹åŒ–å¤±è´¥çš„é—®é¢˜ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨ã€‚
2. **æ–¹æ³•ä¸‰ï¼ˆå‘½åå·ï¼ŒDocker è‡ªåŠ¨å¤„ç†ï¼‰**ï¼š å¯¹è¿ç»´æ›´ç®€æ´ï¼Œå»ºè®®ç”Ÿäº§ã€‚
3. **æ–¹æ³•äºŒï¼ˆ-v :zï¼‰**ï¼š é€‚åˆä¸´æ—¶è°ƒè¯•ï¼Œä½†æ— æ³•è§£å†³å¯¹å®é™… UID çš„ä¸åŒ¹é…ï¼ˆæœ€åå°è¯•ï¼‰ã€‚

---

### æ›´è¿›ä¸€æ­¥çš„è°ƒè¯•ä¿¡æ¯

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯é—®é¢˜ï¼š

```bash
# æŸ¥çœ‹ Jenkins å†…è¿è¡Œçš„æ—¥å¿—
docker logs jenkins | grep "can not write"

# æ£€æŸ¥å®¹å™¨å†… `/var/jenkins_home` çš„å®é™…æƒé™é…ç½®
docker exec -it jenkins ls -la /var/jenkins_home

# æŸ¥çœ‹ SELinux æˆ– AppArmor çŠ¶æ€ï¼ˆUbuntu ä¸Š AppArmorï¼‰
aa-status
```

---

### â˜‘ï¸ æ£€æŸ¥æ¸…å•

- [x] `ls -l /srv/jenkins` â€” å·²å®Œæˆã€‚
- [x] `id jenkins` â€” å®¹å™¨è¿è¡Œ UID=1000ã€‚
- [ ] `docker exec -it jenkins ls -la /var/jenkins_home` â€” ç¡®è®¤ç›®å½•æˆ·æ˜¯å¦ä¸º jenkinsã€‚

---

### æœ€åé…ç½®å‚è€ƒ

```bash
# å…¸å‹è¿è¡Œå‘½ä»¤

docker run -d \
  -v /srv/jenkins:/var/jenkins_home \
  -p 8080:8080 -p 50000:50000 \
  --user 1000:1000 \
  --name jenkins \
  jenkins/jenkins:lts
```

æˆ–è€…ä½¿ç”¨ `--user root` è½¬ç»•é™åˆ¶ï¼Œä½† **å¾ˆå¤šæ’ä»¶ä¼šåœ¨æƒé™ä¸è¶³æ—¶å‡ºé”™**ï¼Œå®˜æ–¹é•œåƒä¹Ÿæ¨èä½¿ç”¨ UID=1000 çš„ç”¨æˆ·è¿è¡Œã€‚

---

### â­ ç»“è®º

**æ ¹æœ¬åŸå› **æ˜¯ä½ ç”¨ UID=1000 çš„ Jenkins ç”¨æˆ·æŒ‚è½½äº†ä¸€ä¸ªå±äº `root:root` çš„ç›®å½•ï¼Œå°½ç®¡æƒé™æ˜¯ `777`ï¼ŒJenkins ä»éªŒè¯å¤±è´¥å¹¶é€€å‡ºã€‚

âœ… æ¨èæ“ä½œï¼š

```bash
sudo chown -R 1000:1000 /srv/jenkins
docker restart jenkins
```

å³å¯è§£å†³ Jenkins æƒé™é—®é¢˜ã€‚

å¦‚ä½ é‡åˆ°æ–°ç‰ˆ Jenkins LTS å‡çº§ä¾§çš„åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·è¡¥å……è¿è¡Œ `docker logs jenkins` çš„å…¨æ–‡é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç²¾ç¡®è¯Šæ–­ ğŸ‘‡

æ ¹æ®ä½ çš„åé¦ˆä¿¡æ¯ï¼š

- å®¿ä¸»æœºæŒ‚è½½ç›®å½•è·¯å¾„æƒé™ä¸ºï¼š`drwxrwxrwx 3 root root`
- Jenkins å®¹å™¨å†…çš„å½“å‰ç”¨æˆ·æ˜¯ï¼š`uid=1000(jenkins)`ï¼Œå³ä»¥é root ç”¨æˆ·è¿è¡Œ

---

## â— æ ¹æœ¬åŸå› åˆ†æ

è™½ç„¶ä½ çš„ç›®å½•è®¾ç½®äº† **å…¨å±€è¯»å†™**ï¼ˆ`drwxrwxrwx`ï¼‰ï¼Œä½† **Jenkins å®¹å™¨å†…çš„ç”¨æˆ· UID=1000**ï¼Œå¹¶ä¸ç­‰äºå®¿ä¸»æœºä¸­çš„ root UIDï¼ˆ0ï¼‰ã€‚å½“å®¹å™¨å¯åŠ¨æ—¶ï¼ŒJenkins åˆå§‹åŒ–è„šæœ¬ä¼šåœ¨ `/var/jenkins_home` ç›®å½•ä¸‹å°è¯•å†™å…¥å‚è€ƒæ–‡ä»¶æ—¶ï¼ˆå¦‚ `copy_reference_file.log`ï¼‰ï¼Œ**å®ƒä¼šæ£€æŸ¥è¯¥æŒ‚è½½ç›®å½•çš„å±ä¸»æ˜¯å¦ä¸ºè¿è¡Œ Jenkins çš„ç”¨æˆ·ï¼ˆuid=1000ï¼‰**ï¼Œå¦åˆ™å°±ç®— Everyone éƒ½æ˜¯ RW ä¹Ÿä¼šæŠ¥é”™ï¼š

```
Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions
```

è¿™ä¸æ˜¯ Linux æ–‡ä»¶ç³»ç»Ÿæœ¬èº«çš„æƒé™é—®é¢˜ï¼Œè€Œæ˜¯ **Jenkins åº”ç”¨å±‚é¢çš„åˆå§‹åŒ–æƒé™æ£€æŸ¥æœºåˆ¶**ã€‚

---

## âœ… æ¨èè§£å†³æ–¹æ¡ˆ

### **æ–¹æ¡ˆä¸€ï¼šç¡®ä¿å®¿ä¸»æœºç›®å½•æ‰€æœ‰è€… UID åŒ¹é…å®¹å™¨ Jenkins ç”¨æˆ· UID=1000**

```bash
# ä¿®æ”¹å®¿ä¸»æœºæŒ‚è½½ç›®å½•çš„æ‰€æœ‰è€…ä¸º UID=1000
sudo chown -R 1000:1000 /srv/jenkins
```

âš ï¸ åŒæ—¶ **åˆ é™¤ä¹‹å‰åˆ›å»ºçš„å®¹å™¨æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰**ï¼Œä¾‹å¦‚ï¼š

```bash
docker stop jenkins && docker rm jenkins
```

ç„¶åé‡æ–°è¿è¡Œ Jenkins å®¹å™¨ï¼ˆæ— éœ€ --user rootï¼‰ï¼š

```bash
docker run -d \
  -v /srv/jenkins:/var/jenkins_home \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  --user 1000:1000 \
  jenkins/jenkins:lts
```

> âš ï¸ å¦‚æœä½ ä¸åŠ  `--user` è¿è¡Œ Jenkinsï¼Œæœ‰æ—¶å®ƒä¼šé»˜è®¤ä½¿ç”¨é•œåƒå†…è®¾å®šçš„ jenkins ç”¨æˆ·ï¼›ä½†æ˜¯ä½ éœ€è¦ä¿è¯ UID åŒ¹é…ï¼Œå¦åˆ™ä¾ç„¶å¤±è´¥ã€‚

---

### **æ–¹æ¡ˆäºŒï¼šä½¿ç”¨å‘½åå·ï¼Œç”± Docker è‡ªåŠ¨é€‚é…æƒé™ï¼ˆæ¨èï¼‰**

å³ä¸ç›´æ¥æŒ‚è½½ä½ å®¿ä¸»æœºçš„è·¯å¾„ï¼Œè€Œæ˜¯ä½¿ç”¨ Docker åˆ›å»ºå‘½åå·ï¼ˆnamed volumeï¼‰ï¼š

```bash
# åˆ›å»ºå‘½åå·
docker volume create jenkins_home

# ä½¿ç”¨è¯¥å‘½åå·æŒ‚è½½ï¼Œä¸ä¾èµ–å®¿ä¸»æœº UID
docker run -d \
  -v jenkins_home:/var/jenkins_home \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  jenkins/jenkins:lts
```

âœ… ä¼˜ç‚¹ï¼š
- Jenkins ä¼šè‡ªåŠ¨é€‚é…è¯¥ç›®å½•çš„æƒé™ã€‚
- æ— éœ€æ‰‹åŠ¨è°ƒæ•´ `chown`ã€‚

---

### **æ–¹æ¡ˆä¸‰ï¼šå¼€å‘ç¯å¢ƒä¸´æ—¶å†³ç­–æ–¹æ¡ˆï¼šä»¥ root è¿è¡Œå®¹å™¨ï¼ˆâš ï¸ ä¸é€‚åˆç”Ÿäº§ï¼‰**

```bash
# ä¸å»ºè®®é•¿æœŸä½¿ç”¨ï¼Œä»…é€‚åˆå¿«é€Ÿæµ‹è¯•
docker run -d \
  -v /srv/jenkins:/var/jenkins_home \
  -p 8080:8080 -p 50000:50000 \
  --name jenkins \
  --user root \
  jenkins/jenkins:lts
```

âš ï¸ å®‰å…¨é£é™©ï¼š
- Jenkins å®¹å™¨å†…ä»¥ root è¿è¡Œï¼Œå¦‚æœæŒ‚è½½çš„è·¯å¾„æ˜¯ `/root`æˆ–å…¶ä»–æ•æ„Ÿè·¯å¾„ï¼Œå¯èƒ½é€ æˆè®¿é—®æ³„éœ²ã€‚

---

### âœ… æœ€ä½³å®è·µæ–¹æ¡ˆï¼ˆæ¨èé‡‡ç”¨ï¼‰

**ä½¿ç”¨ Docker-named-volume + æŒ‡å®š UID=1000 çš„ Jenkins ç”¨æˆ·**

```bash
# åˆ›å»ºå‘½åå·
docker volume create jenkins_home

# ä½¿ç”¨åŒ¹é… UID/GID çš„æ–¹å¼è¿è¡Œå®¹å™¨
docker run -d \
  -v jenkins_home:/var/jenkins_home \
  -p 8080:8080 \
  -p 50000:50000 \
  --name jenkins \
  --user 1000:1000 \
  jenkins/jenkins:lts
```

è¿™æ ·æ—¢é¿å…äº†ä½ æ‰‹åŠ¨ç®¡ç†å’Œè®¾ç½®å®¿ä¸»æœºç›®å½•æƒé™ï¼Œåˆä¿è¯äº† Jenkins æ­£å¸¸è¿è¡Œç”¨æˆ·çš„åŒ¹é…ã€‚

---

## ğŸ§ª éªŒè¯æ˜¯å¦ä¿®å¤æˆåŠŸ

**è¿è¡ŒæˆåŠŸåï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç¡®è®¤ï¼š**

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—æ˜¯å¦ä»æœ‰é”™è¯¯
docker logs jenkins

# ç¡®è®¤èƒ½å¦è¯»å†™ /var/jenkins_home çš„å†…å®¹
docker exec -it jenkins touch /var/jenkins_home/testfile && echo OK || echo FAIL

# å†æ¬¡æŸ¥çœ‹ Jenkins å†…éƒ¨ç”¨æˆ·åå’Œ UID æƒ…å†µ
docker exec -it jenkins id
> è¿”å›ç¤ºä¾‹ï¼šuid=1000(jenkins) gid=1000(jenkins) groups...

docker exec -it jenkins whoami
> è¿”å› jenkins
```

---

## âš ï¸ å°ç»“

| æ–¹å¼            | æ“ä½œéš¾åº¦ | æ˜¯å¦é€‚åˆç”Ÿäº§ | æ˜¯å¦è§£å†³"Wrong volume permissions"é”™è¯¯ |
|------------------|-----------|--------------|--------------------------------------|
| chmod + chown     | ä¸­        | âœ…            | âœ…âœ…âœ… æœ€æœ‰æ•ˆè§£æ³•                        |
| named volume + container user | é«˜        | âœ…âœ…          | âœ… æ¨èæ–¹å¼                              |
| run as root      | ä½        | âŒ             | âœ… ä¸´æ—¶ç”¨æ³•ï¼Œä½†æœ‰ **å®‰å…¨é£é™©**             |
| -v ...:z (SELinux/AppArmor)  | ä½        | âœ…            | âŒ Ubuntu ä¸‹ AppArmor ä¸ä¸€å®šä¼šå› æ­¤è§£é™¤ Jenkins å†…è‡ªå¸¦çš„ UID æ£€æŸ¥é€»è¾‘ |

---

## ğŸ’¬ å¦‚æœä»ç„¶æ— æ³•è§£å†³

è¯·é™„ä¸Šä»¥ä¸‹å®Œæ•´æ—¥å¿—è¾“å‡ºï¼š

```bash
docker logs jenkins | grep -i "permission denied\|wrong volume permissions"
```

æˆ‘å¯ä»¥ä¾æ®å®Œæ•´çš„é”™è¯¯é€»è¾‘ï¼Œåˆ†æå…¶ä»–å¯èƒ½çš„åŸå› ï¼Œå¦‚ï¼š

- å®¿ä¸»æœºç›®å½•ä¸‹æŸå­ç›®å½•æ–‡ä»¶ä»å± root
- Jenkins_home åˆå§‹åŒ–é…ç½®æœªé€šè¿‡ï¼ˆå¦‚ä» /usr/share/jenkins/ref/ æ‹·è´çš„æ–‡ä»¶å—é™ï¼‰
- ä½ è¿è¡Œäº†ä¸€ä¸ªå®šåˆ¶ Jenkins é•œåƒå¹¶æ›´æ”¹äº†ç”¨æˆ·æœºåˆ¶å´ä¸å…¼å®¹ `/var/jenkins_home` ç›®å½•

--- 

æ˜¯å¦éœ€è¦æˆ‘æä¾›è¿™éƒ¨åˆ†çš„æ—¥å¿—è¯Šæ–­ï¼Ÿä½ å¯ä»¥ç›´æ¥ç²˜è´´æ—¥å¿—å†…å®¹ï¼Œæˆ‘å¸®ä½ åˆ†æ âœ…

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

æŸ¥çœ‹å½“å‰ç”¨æˆ·`id`
```bash
$ id
uid=1000(ray) gid=1003(ray) groups=1003(ray),4(adm),20(dialout),24(cdrom),27(sudo),29(audio),44(video),46(plugdev),60(games),100(users),107(netdev),992(render),995(input),1000(gpio),1001(spi),1002(i2c)
```

æŸ¥çœ‹å½“å‰ç”¨æˆ·ç»„`id`
```bash
$ id -g
1003
```

æ›´æ”¹`jenkins_home`ç›®å½•æƒé™ä¸ºå½“å‰ç”¨æˆ·
```bash
$ sudo chown -R 1000:1003 /srv/jenkins_home
```

ç¼–è¾‘ `docker-compose.yml`
```yaml
version: '3.6'
services: 
  jenkins: 
    image: docker.mybacc.com/jenkins/jenkins:lts-jdk17
    container_name: jenkins
    privileged: true
    restart: always
    user: '${UID}:${GID}'
    environment:
      - UID=${UID}
      - GID=${GID}
    ports:
      - '8080:8080'
      - '50000:50000'
    volumes: 
       - '/srv/jenkins_home/data:/var/jenkins_home'
```

åœæ­¢å¹¶åˆ é™¤å®¹å™¨
```bash
$ sudo docker stop jenkins && docker rm jenkins
```

å¯åŠ¨å®¹å™¨
```bash
$ sudo UID=$(id -u) GID=$(id -g) docker-compose up -d
```

éªŒè¯
```bash
$ sudo docker ps
CONTAINER ID   IMAGE                                         COMMAND                  CREATED          STATUS          PORTS                                                                                          NAMES
2f691fc0d8cd   docker.mybacc.com/jenkins/jenkins:lts-jdk17   "/usr/bin/tini -- /uâ€¦"   29 seconds ago   Up 27 seconds   0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcp, 0.0.0.0:50000->50000/tcp, [::]:50000->50000/tcp   jenkins
```
